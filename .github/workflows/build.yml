name: Build Arch Package

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-kicad-${{ github.sha }}
          restore-keys: |
            ccache-kicad-

      - name: Build in Arch container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            -e CCACHE_DIR=/workspace/.ccache \
            archlinux:base-devel bash -c '
              set -e
              
              # Setup pacman
              pacman-key --init
              pacman -Syu --noconfirm
              
              # Install dependencies
              pacman -S --noconfirm --needed \
                git ccache cmake ninja zlib mesa boost boost-libs glew \
                wxwidgets-gtk3 python glm curl swig tar gzip \
                python-wxpython opencascade ngspice unixodbc libgit2 \
                protobuf nng libspnav poppler poppler-glib webkit2gtk-4.1
              
              # Create build user
              useradd -m builder
              chown -R builder:builder /workspace
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
              
              # Setup ccache
              mkdir -p /workspace/.ccache
              chown -R builder:builder /workspace/.ccache
              su builder -c "ccache --set-config=max_size=1G"
              su builder -c "ccache --set-config=compression=true"
              su builder -c "ccache -z"
              
              # Configure makepkg to use ccache
              sed -i "s/!ccache/ccache/" /etc/makepkg.conf
              echo "export PATH=\"/usr/lib/ccache/bin:\$PATH\"" >> /etc/makepkg.conf
              echo "export CCACHE_DIR=/workspace/.ccache" >> /etc/makepkg.conf
              
              # Build
              su builder -c "makepkg -s --noconfirm"
              
              # Show stats
              su builder -c "ccache -s"
            '

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: kicad-nightly-package
          path: "*.pkg.tar.zst"
          retention-days: 30

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.zst"
